=================================================================
== COMPILAR E INSTALAR PIPEWIRE + WIREPLUMBER A MANO EN DEBIAN ==
=================================================================

Instalamos dependencias previas (si usamos systemd para lanzar el servicio de pipewire,
ya que sin esto no se podrá instalar el servicio de usuario de pipewire que es como se debe lanzar normalmente):
sudo apt-get install systemd-dev

Nos bajamos la última release de aquí:
https://gitlab.freedesktop.org/pipewire/pipewire/-/releases

Configuramos y compilamos:

mkdir b4
cd b4

CFLAGS="-march=native -mtune=native -O2 -fomit-frame-pointer" \
CXXFLAGS="-march=native -mtune=native -O2 -fomit-frame-pointer" \
meson setup .. -Dsystemd-user-service=enabled -Dgstreamer=disabled -Dbluez5=disabled -Djack=disabled -Dpipewire-jack=disabled \
-Dv4l2=disabled -Dpipewire-v4l2=disabled -Dman=disabled -Draop=disabled -Dopus=disabled \
-Dlibusb=disabled -Davb=disabled -Ddbus=disabled

ninja -j10
sudo ninja install
sudo ldconfig
(OJO!!! SIEMPRE regenera la caché de librerías después de instalar!!)
(NOTA: Wireplumber se compila e instala al compilar e instalar pipewire, a no ser que le digamos que no lo haga
 o deshabilitemos algo que Wireplumber necesita).

--Recargamos todos los servicios:
systemctl --user daemon-reload

-Comprobamos que los tres servicios importantes de Pipewire están funcionando:
(Los tres deben salir como "active (running)")

systemctl --user status pipewire.socket
systemctl --user status pipewire.service
systemctl --user status wireplumber.service

--Comprobamos que hay sonido por pipewire:
pw-cat -p /usr/share/sounds/alsa/Front_Center.wav

--Ahora ponemos a punto pipewire-alsa, la capa de emulación de ALSA sobre PIPEWIRE.
----Al ser una compilación nuestra de PIPEWIRE, los plugins que PIPEWIRE le mete a ALSA para que ALSA corra sobre PIPEWIRE
    se instalan en /usr/local/lib/x86_64-linux-gnu/alsa-lib en vez de en /usr/lib/x86_64-linux-gnu/alsa-lib que es donde ALSA
    los busca normalmente. Así que le decimos a ALSA dónde buscar los plugins.
    Para que lo vean los programas gráficos lanzados desde Wayland (ya que esto es leído por "systemd user session",
    cosa que sucede porque hemos lanzado Wayland usando un servicio de SystemD)
    creamos "~/.config/environment.d/pipewire.conf" con el contenido: 
	ALSA_PLUGIN_DIR=/usr/local/lib/x86_64-linux-gnu/alsa-lib
	Para que lo vean los programas lanzados desde la terminal o desde SSH, añadimos a .bashrc:
	export ALSA_PLUGIN_DIR=/usr/local/lib/x86_64-linux-gnu/alsa-lib
----Y para que cargue los plugins, que físicamente son unas librerías .so, creamos /etc/asound.conf con el contenido:    

# Al decirle "type pipewire" ALSA buscará los plugins llamados "libasound_module_ctl_pipewire.so"
# y "libasound_module_pcm_pipewire.so".
# Si le dijésemos "type pepito" buscaría "libasound_module_ctl_pepito.so" y "libasound_module_pcm_pepito.so")
pcm.pipewire {
    type pipewire
}

ctl.pipewire {
    type pipewire
}

pcm.!default {
    type pipewire
}

ctl.!default {
    type pipewire
}
----Probamos pipewire-alsa con:
pipewire &
wireplumber &
speaker-test -D pipewire
pkill wireplumber
pkill pipeqire
    ...Y debería sonar.

--RECUERDA: Podemos ver la prioridad de los hilos creados por Pipewire con:
ps -eLo pid,tid,comm,policy,rtprio,ni | grep $(pidof pipewire)
OJO!!!! El hilo principal "pipewire" NO tendrá prioridad RT ni tiene por qué tenerla,
pero los hilos de audio que crea, SÍ que nos saldrán con FF y 88!!!!
(O el valor de RTPrio que tengamos en el argumento "rt.prio" del módulo "libpipewire-module-rt"
 en /usr/local/share/pipewire/pipewire.conf)

OPCIONAL: QUITAR ERRORRES DE WIREPLUMBER
Estos errores sólo se ven si lanzamos Wireplumber a mano en lugar de lanzarlo desde el servicio
que se instala normalmente al instalar Pipewire.
----Para que no nos de errores de BLUEZ y V4L2, editamos /usr/local/share/wireplumber/wireplumber.conf
y buscamos estas líneas y las ponemos a "disabled":
hardware.bluetooth = required
hardware.video-capture = required
----Para que no nos de errores tipo "assertion 'already_registered_dispatcher == self' failed"
editamos /usr/local/share/wireplumber/wireplumber.conf, buscamos "automute-alsa-routes" y comentamos esa sección incluida las llaves,
y justo debajo en la sección "policy.device.routes" quitamos de los wants el "hooks.device.routes.automute-alsa".

==== EXPLICACIÓN TÉCNICA DE LOS VALORES DE PIPEWIRE.CONF ====
	
Un quantum de 512 significa que "el audio se ejecuta cada 512 samples". Es decir, que pipewire recoje el audio del cliente cada 512 samples.
Una frecuencia de 48000 Hz significa que el audio se reproduce a 48000. Es decir, que haya lo que haya en el buffer de audio
se reproduce a 48000 samples por segundo.

O sea, tenemos 512 "samples / ejecución", y tenemos 48000 "samples / segundo".
Para saber cada cuánto se está ejecutando pipewire, nos interesa conocer "segundos / ejecución".
Como queremos "segundos" arriba y "ejecución" abajo, multiplicamos en cruz (que es como se dividen fracciones):

 samples     samples     samples * segundo
--------- X --------- = ---------------------
ejecución    segundo     samples * ejecución

Samples con samples se van, y nos queda: "segundos / ejecución", que es lo que queremos.

Para no tener que ponerlo como fracciones, nos basta con invertir la segunda fracción (samples/segundo) para que sea como multiplicar en cruz,
con lo que nos queda que en el ejemplo concreto, (512) * (1/48000) = 512 / 48000 = 0.010666 = 10.666 ms de retardo de audio. 
