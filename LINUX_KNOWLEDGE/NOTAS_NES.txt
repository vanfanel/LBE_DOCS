EXTRAER EL PRG Y CHR DE UN ARCHIVO .NES
=======================================
ALGUNA INFO PROCEDE DE: https://forums.nesdev.org/viewtopic.php?t=5661

Recuerda que cada dos caracteres en Hexedit son un byte.

Un .NES está estructurado así: header + PRG ROM + CHR ROM.
A veces sólo tienen: header + PRG ROM.

La cabecera de un .NES son 16 bytes. Eso fijo.
Podemos ver el tamaño del PRG y CHR de cada .NES concreto abriéndolo con HEXEDIT:
El byte 0x0004, es decir, el byte con la quinta posición, es el tamaño del PRG en bloques de 16K (16384 bytes).
El byte 0x0005, es decir, el byte con la sexta posición, es el tamaño del CHR en bloques de 8K (8192 bytes).
(También podríamos cargarlo con el MESEN y en "Tools -> Log Window" nos dice el tamaño del PRG y el CHR).

Usando "dd" con los parámetros bs, size, count y skip podemos hacer todo lo necesario para extraer y reinsertar las partes de la ROM.

Supongamos un juego con 128 KB de PRG y 128 KB de CHR llamado "kiwi.nes".
Vamos a "despiezarlo":

--Miramos el byte 0x0004 y 0x0005, que son 0x08 y 0x10, lo que nos dice que tenemos 128 KB de PRG y 128 K de CHR. 

--Extraemos la cabecera:
dd if=kiwi.nes of=header bs=1c count=16 skip=0
("Cada bloque es un byte, no me salto ningún bloque y extraemos 16 bytes").

--Extraemos el PRG:
dd if=kiwi.nes of=kiwi.prg bs=1c skip=16 count=128K
("Cada bloque es 1 byte, nos saltamos los primeros 16 bytes, extraemos 128 KB").

--Extraemos el CHR:
dd if=kiwi.nes of=kiwi.chr bs=1c skip=$((16 + 128*1024)) count=128K
("Cada bloque es 1 byte, nos saltamos los primeros 16 bytes y los siguientes 128 KB, y extraemos 128 KB".
  El número de bytes a saltarnos se calcula usando lo que se llama "aritmética del shell". El cálculo en sí es trivial).

AHORA VAMOS A INTENTAR VOLVER A "MONTAR" EL JUEGO
NOTA: Para saltarse bloques en el destino es con "seek" en vez de "skip" que era para saltárselos en el orígen.
NOTA: Al escribir dentro de un fichero ya existente, tenemos que pasarle "conv=notrunc"
      porque si no, nos sobreescribe el fichero existente con lo que deseamos escribir en él.

--Creo un fichero de 262160 bytes que es el tamaño que tiene el juego original
(16 bytes de cabecera + 128 KB = 131072 bytes de PRG + 128 KB = 131072 bytes de CHR)
dd if=/dev/zero of=kiwi2.nes bs=1c count=262160

--Copio la cabecera a su sitio:
dd if=header of=kiwi2.nes bs=1c skip=0 count=16 conv=notrunc

--Metemos el PRG después de los 16 bytes de la cabecera:
dd if=kiwi.prg of=kiwi2.nes bs=1c seek=16 conv=notrunc

--Metemos el CHR después de la cabecera y el PRG:
dd if=kiwi.chr of=kiwi2.nes bs=1c seek=$((16 + 128*1024)) conv=notrunc

NOS PONEMOS SERIOS: EXTRAER LOS GRÁFICOS EN BLOQUE
==================================================

La PPU de la NES sólo puede acceder a 8KB en un momento dado (los CHR son más grandes porque se usa bank switching).

La cosa ahora es saber qué parte del CHR está puesto en ese momento en el banco accesible por la PPU:
Para ello, en MESEN, pausamos el juego en el momento en que están en pantalla los gráficos que queremos cambiar,
vamos a Debug -> Memory Viewer, seleccionamos "PPU Memory", nos ponemos con el ratón en el primer byte,
y nos dice la "CHR Address", que es la dirección en el CHR donde empiezan los 8 KB que están en ese momento en el banco accesible por la PPU.
Estos 8 KB van de 0x0000 a 0x1FFF.

Supongamos que la PPU Memory en ese momento empieza en 0xB000.

--Si queremos extraer esos 8 KB del fichero CHR, hacemos:
dd if=kiwi_pal.chr of=titulo_pal.chr bs=1c count=8192 skip=$((0xB000))

--Si queremos insertar estos 8 KB en la misma dirección de otro CHR:
dd if=titulo_pal.chr of=kiwi_ntsc.chr bs=1c count=8192 seek=$((0xB000))

--Si ahora queremos re-insertar el CHR modificado en la ROM:
dd if=titulo_pal.chr of=kiwi_ntsc.chr bs=1c count=8192 seek=$((0xB000))

EDITAR GRÁFICOS SENCILLOS (SPRITES)
===================================

Lo más fácil es usar el "Tile Layer Pro", que va con WINE.
Cargamos la ROM, montamos el "personaje" en el "Tile Arranger" ya que lo normal es que un personaje sean varios "tiles",
y cambiamos lo que queramos ahí.
